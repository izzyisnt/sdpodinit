#!/usr/bin/env bash
set -euo pipefail
echo "ğŸ§© Starting parallel SurfDock environment install..."

export PIP_DISABLE_PIP_VERSION_CHECK=1
export PYTHONWARNINGS="ignore"


# â”€â”€â”€â”€â”€ System Dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“¦ Installing system packages..."
apt-get update
apt-get install -y \
  python3.10-dev \
  swig \
  build-essential \
  git \
  openbabel

# â”€â”€â”€â”€â”€ Core Scientific Stack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_core_sci() {
  echo "ğŸ“¦ Installing core scientific Python packages..."
  pip install \
    numpy==1.24.4 \
    scipy==1.8.1 \
    pandas==2.1.2 \
    scikit-learn==1.3.2
}

# â”€â”€â”€â”€â”€ Chemistry & Docking Stack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_chem_stack() {
  echo "ğŸ§ª Installing docking and chemistry libraries..."
  pip install \
    rdkit-pypi==2022.9.5 \
    openmm==8.2.0 \
    biopython==1.79 \
    babel==2.13.1 \
    biopandas==0.4.1


  pip install git+https://github.com/openmm/openmmforcefields.git
  pip install importlib_resources
  pip install git+https://github.com/prody/ProDy.git
  pip install git+https://github.com/openmm/pdbfixer.git@master
}

# â”€â”€â”€â”€â”€ ML Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_ml_utils() {
  echo "ğŸ§  Installing ML utilities..."
  pip install \
    torchmetrics==1.2.1 \
    torch-ema==0.3 \
    accelerate==0.15.0 \
    wandb==0.16.1
}

# â”€â”€â”€â”€â”€ PyTorch Geometric â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_pyg() {
  echo "ğŸ”— Installing PyTorch Geometric packages..."
  pip install \
    e3nn==0.5.1 \
    pyg_lib \
    torch_scatter \
    torch_sparse \
    torch_cluster \
    torch_spline_conv \
    --find-links https://data.pyg.org/whl/torch-2.5.1+cu121.html
}

# â”€â”€â”€â”€â”€ Mesh / Geometry Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_mesh_tools() {
  echo "ğŸ“ Installing mesh and geometry tools..."
  pip install \
    trimesh \
    pymeshfix \
    plyfile
  pip install https://github.com/nuvolos-cloud/PyMesh/releases/download/v0.3.1/pymesh2-0.3.1-cp310-cp310-linux_x86_64.whl
}

# â”€â”€â”€â”€â”€ Utility + NLP Packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_utils() {
  echo "ğŸ› ï¸  Installing utility and NLP packages..."
  pip install \
    loguru \
    prefetch_generator \
    dimorphite_dl \
    huggingface-hub==0.17.3 \
    tokenizers==0.13.3 \
    transformers==4.29.2
}

# â”€â”€â”€â”€â”€ ESM Model (Optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_esm() {
  echo "ğŸ§¬ Installing ESM model..."
  pip install git+https://github.com/facebookresearch/esm.git
}

# â”€â”€â”€â”€â”€ Run All Groups in Parallel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_core_sci &
PID1=$!
install_chem_stack &
PID2=$!
install_ml_utils &
PID3=$!
install_pyg &
PID4=$!
install_mesh_tools &
PID5=$!
install_utils &
PID6=$!
install_esm &
PID7=$!

# Wait for all parallel jobs to finish
wait $PID1 $PID2 $PID3 $PID4 $PID5 $PID6 $PID7

echo "âœ… All parallel install groups completed successfully!"

